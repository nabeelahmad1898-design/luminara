<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manager Login | Luminara</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS SDK v2 (UMD build exposes window.supabase) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    :root {
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --gold-primary: #FFD700;
      --text-primary: #FFFFFF;
      --text-secondary: #b3b3b3;
    }
    body { background: var(--bg-primary); color: var(--text-primary); font-family: Roboto, system-ui, -apple-system, Segoe UI, Inter, Helvetica, Arial, sans-serif; }
    .card { background: var(--bg-secondary); border: 1px solid #1a1a1a; border-radius: 0.75rem; }
    .form-input { background: #0f0f0f; border: 1px solid #1a1a1a; color: #fff; border-radius: 0.5rem; padding: 0.75rem 1rem; width: 100%; }
    .form-input::placeholder { color: #7f7f7f; }
    .form-input:focus { outline: none; border-color: var(--gold-primary); box-shadow: 0 0 0 3px rgba(255,215,0,.18); }
    .btn-primary { background: var(--gold-primary); color: #000; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.5rem; }
    .btn-secondary { border: 1px solid var(--gold-primary); color: var(--gold-primary); font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.5rem; }
    .btn-secondary:hover { background: #FFD700; color: #000; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
  <div class="min-h-screen grid place-items-center p-4">
    <div class="card w-full max-w-md p-6">
      <div class="mb-6 text-center">
        <h1 class="text-2xl font-bold text-yellow-500">Luminara Manager Portal</h1>
        <p class="text-sm text-gray-300 mt-1">Sign in to manage products and content</p>
      </div>

      <!-- Supabase Auth Panel (shown when Supabase is configured) -->
      <div id="supabase-panel" class="hidden">
        <h2 class="text-lg font-semibold mb-3">Manager Login</h2>
        <p class="text-gray-300 text-sm mb-4">Sign in with your Supabase account. Only users with the admin role can access the dashboard.</p>
        <form id="sp-login-form" class="space-y-3">
          <input class="form-input" type="email" id="sp-email" placeholder="Email" required />
          <input class="form-input" type="password" id="sp-pass" placeholder="Password" required />
          <button class="btn-primary w-full" type="submit">Login</button>
        </form>
        <div class="text-sm text-gray-400 mt-4">Need an account? Create one:</div>
        <form id="sp-signup-form" class="space-y-3 mt-2">
          <input class="form-input" type="email" id="sp-su-email" placeholder="Email" required />
          <input class="form-input" type="password" id="sp-su-pass" placeholder="Password" required />
          <button class="btn-secondary w-full" type="submit">Sign Up</button>
        </form>
        <p class="text-xs text-gray-400 mt-3">After signup, set your role to <span class="text-yellow-500">admin</span> in the `profiles` table in Supabase to gain access.</p>
        <div class="text-xs text-gray-500 mt-2">Env: <span id="sp-env" class="text-yellow-500"></span></div>
      </div>

      <!-- Local 2FA Setup/Login Panels (fallback when Supabase is NOT configured) -->
      <div id="setup-panel" class="hidden">
        <h2 class="text-lg font-semibold mb-3">Initial Setup</h2>
        <p class="text-gray-300 text-sm mb-4">Create an admin password. This is stored locally in this browser only.</p>
        <form id="setup-form" class="space-y-3">
          <input class="form-input" type="email" id="setup-email" placeholder="Admin email (optional)" />
          <input class="form-input" type="password" id="setup-pass" placeholder="Create password" required />
          <input class="form-input" type="password" id="setup-pass2" placeholder="Confirm password" required />
          <button class="btn-primary w-full" type="submit">Save & Continue</button>
        </form>
        <button id="switch-to-login" class="btn-secondary w-full mt-3">I already have a password</button>
      </div>

      <div id="login-panel" class="hidden">
        <h2 class="text-lg font-semibold mb-3">Manager Login</h2>
        <form id="login-form" class="space-y-3">
          <input class="form-input" type="password" id="login-pass" placeholder="Password" required />
          <input class="form-input" type="text" id="login-code" placeholder="6-digit code" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" required />
          <button class="btn-primary w-full" type="submit">Login</button>
        </form>
        <button id="switch-to-setup" class="btn-secondary w-full mt-3 hidden">Set up password on this device</button>
      </div>

      <div id="setup-2fa-panel" class="hidden">
        <h2 class="text-lg font-semibold mb-2">Two-Step Verification</h2>
        <p class="text-gray-300 text-sm mb-3">Scan the QR code with an Authenticator app (Google Authenticator, Microsoft Authenticator, etc.). Then enter the 6-digit code to complete setup.</p>
        <div class="grid place-items-center my-3">
          <canvas id="qrCanvas" class="bg-white rounded p-2"></canvas>
        </div>
        <div class="text-sm text-gray-400 mb-2">Secret: <span id="totpSecretText" class="text-yellow-500"></span></div>
        <form id="verify-2fa-form" class="space-y-3">
          <input class="form-input" type="text" id="verify-code" placeholder="Enter 6-digit code" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" required />
          <button class="btn-primary w-full" type="submit">Verify & Continue</button>
        </form>
        <button id="back-to-login" class="btn-secondary w-full mt-3 hidden">Back to login</button>
      </div>

      <div class="text-center mt-6 space-y-2">
        <a href="supabase-config.html" class="text-sm text-yellow-500 hover:text-yellow-400 block">⚙️ Configure Supabase</a>
        <a href="index.html" class="text-sm text-gray-400 hover:text-yellow-500">← Back to Storefront</a>
      </div>
    </div>
  </div>

  <script>
    console.log('Admin script loading...');
    // Supabase config
    const SUPABASE_URL = window.SUPABASE_URL || localStorage.getItem('SUPABASE_URL') || '';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || localStorage.getItem('SUPABASE_ANON_KEY') || '';
    const spConfigured = SUPABASE_URL.startsWith('http') && SUPABASE_ANON_KEY && !/YOUR_/.test(SUPABASE_ANON_KEY);
    const sp = spConfigured ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
    console.log('Supabase configuration check:', {
      url: SUPABASE_URL,
      keyExists: !!SUPABASE_ANON_KEY,
      spConfigured: spConfigured,
      supabaseClient: !!window.supabase,
      sp: !!sp
    });
    // Minimal client-side session; for real deployments use a backend.
    const ADMIN_HASH_KEY = 'adminPasswordHash';
    const ADMIN_EMAIL_KEY = 'adminEmail';
    const ADMIN_SESSION_KEY = 'adminSession';
    const ADMIN_TOTP_SECRET_KEY = 'adminTotpSecret';
    const ADMIN_2FA_ENABLED_KEY = 'admin2faEnabled';

    function getAdminHash() {
      return localStorage.getItem(ADMIN_HASH_KEY);
    }
    function setAdminHash(hash) {
      localStorage.setItem(ADMIN_HASH_KEY, hash);
    }
    function setAdminEmail(email) {
      if (email) localStorage.setItem(ADMIN_EMAIL_KEY, email);
    }
    function createSession() {
      const token = 'adm-' + Math.random().toString(36).slice(2) + Date.now();
      const session = { token, expiresAt: Date.now() + 12 * 60 * 60 * 1000, twoFactor: true };
      localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify(session));
      return session;
    }
    function getSession() {
      try {
        const obj = JSON.parse(localStorage.getItem(ADMIN_SESSION_KEY) || 'null');
        if (!obj) return null;
        if (Date.now() > (obj.expiresAt || 0)) { localStorage.removeItem(ADMIN_SESSION_KEY); return null; }
        return obj;
      } catch { return null; }
    }
    async function sha256Hex(text) {
      const enc = new TextEncoder();
      const data = enc.encode(text);
      const digest = await crypto.subtle.digest('SHA-256', data);
      const bytes = Array.from(new Uint8Array(digest));
      return bytes.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Base32 helpers (RFC 4648)
    const BASE32_ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    function base32Encode(bytes) {
      let bits = 0, value = 0, output = '';
      for (let i = 0; i < bytes.length; i++) {
        value = (value << 8) | bytes[i];
        bits += 8;
        while (bits >= 5) {
          output += BASE32_ALPHABET[(value >>> (bits - 5)) & 31];
          bits -= 5;
        }
      }
      if (bits > 0) output += BASE32_ALPHABET[(value << (5 - bits)) & 31];
      return output;
    }
    function base32Decode(str) {
      const clean = str.replace(/=+$/,'').toUpperCase();
      let bits = 0, value = 0; const out = [];
      for (let i = 0; i < clean.length; i++) {
        const idx = BASE32_ALPHABET.indexOf(clean[i]);
        if (idx === -1) continue;
        value = (value << 5) | idx;
        bits += 5;
        if (bits >= 8) {
          out.push((value >>> (bits - 8)) & 255);
          bits -= 8;
        }
      }
      return new Uint8Array(out);
    }

    // HOTP/TOTP
    async function hmacSha1(keyBytes, messageBytes) {
      const key = await crypto.subtle.importKey('raw', keyBytes, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
      const sig = await crypto.subtle.sign('HMAC', key, messageBytes);
      return new Uint8Array(sig);
    }
    function counterToBytes(counter) {
      const b = new Uint8Array(8);
      for (let i = 7; i >= 0; i--) { b[i] = counter & 0xff; counter = Math.floor(counter / 256); }
      return b;
    }
    function truncateHotp(hmac, digits = 6) {
      const offset = hmac[hmac.length - 1] & 0x0f;
      const code = ((hmac[offset] & 0x7f) << 24) | (hmac[offset + 1] << 16) | (hmac[offset + 2] << 8) | (hmac[offset + 3]);
      const mod = 10 ** digits;
      const val = code % mod;
      return val.toString().padStart(digits, '0');
    }
    async function generateTOTP(secretBase32, time = Date.now(), step = 30, digits = 6) {
      const secret = base32Decode(secretBase32);
      const counter = Math.floor(time / 1000 / step);
      const hmac = await hmacSha1(secret, counterToBytes(counter));
      return truncateHotp(hmac, digits);
    }
    async function verifyTOTP(secretBase32, code, windowSteps = 1) {
      const now = Date.now();
      for (let w = -windowSteps; w <= windowSteps; w++) {
        const t = now + w * 30 * 1000;
        const expect = await generateTOTP(secretBase32, t);
        if (expect === (code || '').toString().padStart(6, '0')) return true;
      }
      return false;
    }

    function show(panel) {
      document.getElementById('setup-panel').classList.add('hidden');
      document.getElementById('login-panel').classList.add('hidden');
      document.getElementById(panel).classList.remove('hidden');
    }

    // Redirect if already logged in
    const existing = getSession();
    if (existing) { 
      console.log('Existing session found, redirecting to dashboard...');
      window.location.href = 'dashboard.html'; 
    }
    
    // Check Supabase auth status
    if (spConfigured) {
      sp.auth.getUser().then(({ data, error }) => {
        console.log('Current Supabase auth status:', { data, error });
        if (data?.user) {
          console.log('User is already logged in:', data.user.email);
          console.log('User ID:', data.user.id);
        }
      });
    }

    // Decide which auth to show
    if (spConfigured) {
      document.getElementById('sp-env').textContent = SUPABASE_URL.replace(/^https?:\/\//,'');
      show('supabase-panel');
    } else {
      const hasPassword = !!getAdminHash();
      if (hasPassword) { show('login-panel'); } else { show('setup-panel'); }
      
      document.getElementById('switch-to-login').addEventListener('click', () => show('login-panel'));
      const switchToSetupBtn = document.getElementById('switch-to-setup');
      if (!hasPassword) { switchToSetupBtn.classList.remove('hidden'); }
      switchToSetupBtn.addEventListener('click', () => show('setup-panel'));
    }

    // TOTP enrollment state in-memory for setup
    let enrollmentSecret = '';

    document.getElementById('setup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('setup-email').value.trim();
      const p1 = document.getElementById('setup-pass').value;
      const p2 = document.getElementById('setup-pass2').value;
      if (p1.length < 6) { alert('Password must be at least 6 characters'); return; }
      if (p1 !== p2) { alert('Passwords do not match'); return; }
      const hash = await sha256Hex(p1);
      setAdminHash(hash);
      setAdminEmail(email);
      // Generate TOTP secret and prompt verification
      const random = new Uint8Array(20);
      crypto.getRandomValues(random);
      enrollmentSecret = base32Encode(random);
      const issuer = encodeURIComponent('Luminara');
      const label = encodeURIComponent('Manager');
      const uri = `otpauth://totp/${issuer}:${label}?secret=${enrollmentSecret}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;
      document.getElementById('totpSecretText').textContent = enrollmentSecret;
      QRCode.toCanvas(document.getElementById('qrCanvas'), uri, { width: 200 });
      show('setup-2fa-panel');
    });

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const pass = document.getElementById('login-pass').value;
      const code = (document.getElementById('login-code').value || '').replace(/\s+/g, '');
      const hash = await sha256Hex(pass);
      const stored = getAdminHash();
      if (!stored || stored !== hash) { alert('Invalid password'); return; }
      const twoEnabled = localStorage.getItem(ADMIN_2FA_ENABLED_KEY) === 'true';
      const secret = localStorage.getItem(ADMIN_TOTP_SECRET_KEY);
      if (!twoEnabled || !secret) {
        // Force enrollment for legacy installs
        enrollmentSecret = secret || base32Encode(crypto.getRandomValues(new Uint8Array(20)));
        const issuer = encodeURIComponent('Luminara');
        const label = encodeURIComponent('Manager');
        const uri = `otpauth://totp/${issuer}:${label}?secret=${enrollmentSecret}&issuer=${issuer}&algorithm=SHA1&digits=6&period=30`;
        document.getElementById('totpSecretText').textContent = enrollmentSecret;
        QRCode.toCanvas(document.getElementById('qrCanvas'), uri, { width: 200 });
        alert('Two-step verification is now required. Please enroll by scanning the QR and entering a code.');
        show('setup-2fa-panel');
        return;
      }
      const ok = await verifyTOTP(secret, code, 1);
      if (!ok) { alert('Invalid 2FA code'); return; }
      createSession();
      window.location.href = 'dashboard.html';
    });

    document.getElementById('verify-2fa-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = (document.getElementById('verify-code').value || '').replace(/\s+/g, '');
      if (!enrollmentSecret) { alert('No enrollment secret. Restart setup.'); return; }
      const ok = await verifyTOTP(enrollmentSecret, code, 1);
      if (!ok) { alert('Invalid code, try again. Ensure device time is correct.'); return; }
      localStorage.setItem(ADMIN_TOTP_SECRET_KEY, enrollmentSecret);
      localStorage.setItem(ADMIN_2FA_ENABLED_KEY, 'true');
      createSession();
      window.location.href = 'dashboard.html';
    });

    // Supabase auth handlers
    if (spConfigured) {
      console.log('Setting up Supabase login handler...');
      const loginForm = document.getElementById('sp-login-form');
      if (loginForm) {
        console.log('Login form found, adding event listener...');
        loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Login attempt started...');
        const email = document.getElementById('sp-email').value.trim();
        const password = document.getElementById('sp-pass').value;
        console.log('Attempting login with email:', email);
        
        try {
          const { data, error } = await sp.auth.signInWithPassword({ email, password });
          console.log('Login result:', { data, error });
          
          if (error) { 
            console.error('Login error:', error);
            alert(error.message); 
            return; 
          }
          
          console.log('Login successful, checking user role...');
          
          // Check role in profiles
          const { data: u } = await sp.auth.getUser();
          const uid = u?.user?.id;
          console.log('User ID:', uid);
          
          const { data: prof, error: profError } = await sp.from('profiles').select('role').eq('user_id', uid).maybeSingle();
          console.log('Profile check result:', { prof, profError });
          
          if (profError) {
            console.error('Profile check error:', profError);
            alert('Error checking user role: ' + profError.message);
            return;
          }
          
          if (!prof || prof.role !== 'admin') {
            console.error('User not authorized. Role:', prof?.role);
            alert('Your account is not authorized (role != admin).');
            await sp.auth.signOut();
            return;
          }
          
          console.log('User authorized as admin, creating session...');
          
          // Store a lightweight local session marker for redirect parity
          createSession();
          console.log('Session created, redirecting to dashboard...');
          window.location.href = 'dashboard.html';
          
        } catch (err) {
          console.error('Unexpected error during login:', err);
          alert('Unexpected error: ' + err.message);
        }
      });
      } else {
        console.error('Login form not found!');
      }

      document.getElementById('sp-signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('sp-su-email').value.trim();
        const password = document.getElementById('sp-su-pass').value;
        const { data, error } = await sp.auth.signUp({ email, password });
        if (error) { alert(error.message); return; }
        alert('Account created. Ask the owner to set your role=admin in profiles, then login.');
      });
    }
  </script>
</body>
</html>


